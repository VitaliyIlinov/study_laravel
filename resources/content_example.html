<ul class="main_list">
    <li>
        <a href="#explain">Что такое Explain?</a>
    </li>
    <li>
        <a href="#optimization">Что такое Explain?</a>
    </li>
    <li>
        <a href="#profile">Как профилировать запросы?</a>
    </li>
    <li>
        <a href="#q1"> Есть запрос, который тормозит. С чего стоит начать поиск проблем?<br> Куда смотреть в Explain,
            чтобы понять, что идет не так?
        </a>
    </li>
    <li>
        <a href="https://www.slideshare.net/phpcodemonkey/mysql-explain-explained/">Example</a>
    </li>
</ul>
<div id="explain">
    <p>
        EXPLAIN – разбор работы SQL запроса для дальнейшей оптимизации(сам запрос не выполняеться). Чаще всего задача
        сводиться к правильному составлению индексов для запроса
    </p>
    <p>
        Что Показывает
    </p>
    <ul>
        <li>Количество задействованных строк</li>
        <li>Использование идексов или их отсутсвие</li>
        <li>Порядок доступа к табблицам</li>
    </ul>
</div>

<div id="optimization">
    <ul>
        <li>Создание не обходимых индексов(для полей участвующих в WHERE, JOIN, GROUP BY, ORDER BY)</li>
        <li>Возможно более ефективней будет составной индекс(порядок полей также важен)</li>
        <li>Соотвествие типов полей(связывание полей через WHERE)</li>
        <li>Выборка только нужных полей(вместо *)</li>
    </ul>
    <pre><code>
    EXPLAIN SELECT * FROM a inner join b on id=user_id \G
</code>
</pre>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>id</th>
            <th>select_type</th>
            <th>table</th>
            <th>type</th>
            <th>possible_keys</th>
            <th>key</th>
            <th>key_len</th>
            <th>ref</th>
            <th>rows</th>
            <th>Extra</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <th>1</th>
            <td>SIMPLE</td>
            <td>a</td>
            <td>ALL</td>
            <td>PRIMARY,id_UNIQUE</td>
            <td>null</td>
            <td>null</td>
            <td>null</td>
            <td>3</td>
            <td>null</td>
        </tr>
        <tr>
            <th>1</th>
            <td>SIMPLE</td>
            <td>b</td>
            <td>ALL</td>
            <td>null</td>
            <td>null</td>
            <td>null</td>
            <td>null</td>
            <td>16</td>
            <td>Using where;using join buffer</td>
        </tr>
    </table>
    <p>Что нам эта информация дает?</p>
    <ul>
        <li>
            <b>id</b> - номер строки в таблице EXPLAIN, строк будет столько, сколько операторов SELECT в запросе.
        </li>
        <li>
            <b>select_type</b> - это тип запроса. Он говорит о том, является ли запрос простым (как в нашем случае) или
            же, к примеру, вложенным - когда используются подзапросы (SUBQUERY). Среди возможных значений также могут
            быть:
            <ul>
                <li><b>PRIMARY</b> - внешний запрос при соединении JOIN</li>
                <li><b>DERIVED</b> - запрос является подзапросом в предложении FROM</li>
                <li><b>DEPENDENT SUBQUERY</b> - подзапрос SELECT, который зависит от подзапроса</li>
                <li><b>UNION</b> - запрос, который записан после оператора UNION</li>
                <li><b>DEPENDENT UNION</b> - запрос, который записан после оператора UNION и зависит от подсапроса</li>
                <li><b>UNION RESULT</b> - результирующий запрос SELECT, в котором есть UNION</li>
            </ul>
        </li>
        <li>
            <b>table</b> - таблица, которая использована для запроса. Значения могут совпадать с существующими таблицами
        </li>
        <li>
            <b>type</b> - то как система осуществляет соединение таблиц. Иногда говорят, что это то, как осуществляется
            доступ к значениям в таблице. Например, производился поиск по всей таблице, либо же по определенному
            интервалу. Или же поиск производился исключительно по индексу. Перечислим некоторые значения (от лучших к
            худшим):
            <ul>
                <li><b>system</b> - таблица имеет не более 1 строки.</li>
                <li><b>const</b> - таблица содержит не более 1 совпадения по запросу. При этом критерий поиска был
                    составлен из индексов и в нем использовались лишь постоянные величины.
                </li>
                <li><b>eq_ref</b> - при соединении таблицы были использованы индексы PRIMARY или UNIQUE NOT NULL</li>
                <li><b>ref</b> - при соединении таблицы были использованы индексы</li>
                <li><b>unique_subquery</b> - это аналог ref, когда подзапрос в IN возвращает один результат при помощи
                    индекса
                </li>
                <li><b>index_subquery</b> - аналог unique_subquery, но результатов больше чем 1.</li>
                <li><b>range</b> - поиск проводился в индексе по определенному промежутку. Например, при использовании
                    операторов сравнения.
                </li>
                <li><b>all</b> - была использована вся таблица для поиска записей. Это наиболее плохой результат.</li>
            </ul>
        </li>
        <li>
            <b>possible_keys</b> - возможные индексы для поиска записей(несколько может быть по скольку в WHERE может
            иметь несколько условий по индексируемому полю\полей - составной индекс)
        </li>
        <li>
            <b>keys</b> - индексы, которые были использованы для запроса
        </li>
        <li>
            <b>key_len</b> -количество байт, которое занимает индекс
        </li>
        <li>
            <b>ref</b> - столбцы которые сравнивались с индексами в key
        </li>
        <li>
            <b>rows</b> - количество строк таблицы, которые исследованы для результата. Очевидно, что чем меньше это
            число - тем лучше. (rows умножаються со всех таблиц в explain)
        </li>
        <li>
            <b>extra</b> - дополнительная информация про запрос.
        </li>
    </ul>
</div>

<div id="profile">
    <p>
        Профилирование запросов MySQL – это полезный метод анализа общей производительности приложений на основе БД. Лог
        медленных запросов MySQL (или slow query log) — это лог, в который MySQL отправляет медленные и потенциально
        проблемные запросы. Эта функция поставляется с MySQL, но по умолчанию отключена. MySQL определяет, какие запросы
        нужно внести в этот лог, с помощью специальных переменных, которые позволяют профилировать запрос на основе
        требований к производительности приложения. Обычно в этот лог вносятся запросы, обработка которых занимает
        больше времени, и запросы, которые неправильно индексы. <b>/etc/mysql/mysql.conf.d/mysqld.cnf</b>
    </p>
    <pre><code>
#slow_query_log         = 1   //булево значение включающее лог
#slow_query_log_file    = /var/log/mysql/mysql-slow.log  //путь абсолютный путь к файлу лога.
                            Владельцем каталога должен быть пользователь mysqld, а также директория должна
                            иметь корректные разрешения для чтения и записи. Чаще всего демон mysql работает
                            от имени пользователя mysql.
#long_query_time = 2 //время в секундах для проверки продолжительности запроса &gt;2
#log-queries-not-using-indexes  //тут не надо значение, включает сохранение запросов не использующих индексы
#min_examined_row_limit     //указывает минимальное значение количества рядов данных для анализа. Значение
                                1000 проигнорирует запросы возвращающие меньше 1000 рядов значений.

</code></pre>
    <p>
        Изменения вступят только при очередном запуске MySQL, если вам необходимо динамическое изменение параметров,
        используйте другие методы установки переменных:
    </p>

    <pre><code>
mysql&gt; SET GLOBAL slow_query_log = 'ON';
mysql&gt; SET GLOBAL slow_query_log_file = '/var/log/mysql/localhost-slow.log';
mysql&gt; SET GLOBAL log_queries_not_using_indexes = 'ON';
mysql&gt; SET SESSION long_query_time = 1;
mysql&gt; SET SESSION min_examined_row_limit = 100;
</code></pre>
    <a target="_blank" class="btn btn-secondary" href="https://www.8host.com/blog/profilirovanie-zaprosov-mysql/">
        https://www.8host.com/blog/profilirovanie-zaprosov-mysql/
    </a>
    <a target="_blank" class="btn btn-secondary" href="https://devacademy.ru/article/profilirovanie-zaprosov-v-mysql/">
        https://devacademy.ru/article/profilirovanie-zaprosov-v-mysql/
    </a>
</div>

<div id="q1">
    <p>
        Колонка <b>key</b> показывает используемый индекс. Колонка <b>possible_keys</b> показывает все индексы, которые
        могут быть использованы для этого запроса. Колонка <b>rows</b> показывает число записей, которые пришлось
        прочитать базе данных для выполнения этого запроса
    </p>
</div>

<p><br></p>
